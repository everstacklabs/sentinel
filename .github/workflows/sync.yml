name: Model Sync

on:
  schedule:
    - cron: "0 6,18 * * *" # Every 12 hours at 6am and 6pm UTC
  workflow_dispatch:
    inputs:
      providers:
        description: "Comma-separated providers to sync (blank for all)"
        required: false
        default: ""
      dry_run:
        description: "Dry run (preview changes only)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Build
        run: make build

      - name: Checkout model catalog
        uses: actions/checkout@v4
        with:
          repository: midfusionlabs/model-catalog
          token: ${{ secrets.GH_PAT }}
          path: model-catalog

      - name: Run sync
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SENTINEL_CATALOG_PATH: ./model-catalog
          SENTINEL_GITHUB_OWNER: midfusionlabs
          SENTINEL_GITHUB_REPO: model-catalog
          SENTINEL_GITHUB_BASE_BRANCH: main
        run: |
          ARGS="sync"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          if [ -n "${{ github.event.inputs.providers }}" ]; then
            ARGS="$ARGS --providers=${{ github.event.inputs.providers }}"
          fi

          ./bin/sentinel $ARGS

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK not set, skipping notification"
            exit 0
          fi

          if [ "${{ job.status }}" = "success" ]; then
            COLOR=3066993
            TITLE="Sentinel sync completed"
            DESC="Model catalog sync finished successfully."
          elif [ "${{ job.status }}" = "cancelled" ]; then
            COLOR=15105570
            TITLE="Sentinel sync cancelled"
            DESC="Model catalog sync was cancelled."
          else
            COLOR=15158332
            TITLE="Sentinel sync failed"
            DESC="Model catalog sync encountered an error. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          fi

          curl -s -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DESC\",
              \"color\": $COLOR,
              \"footer\": {\"text\": \"${{ github.repository }} â€¢ Run #${{ github.run_number }}\"}
            }]
          }" "$DISCORD_WEBHOOK"
