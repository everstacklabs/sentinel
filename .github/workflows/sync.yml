name: Model Sync

on:
  schedule:
    - cron: "0 6,18 * * *" # Every 12 hours at 6am and 6pm UTC
  workflow_dispatch:
    inputs:
      providers:
        description: "Comma-separated providers to sync (blank for all)"
        required: false
        default: ""
      dry_run:
        description: "Dry run (preview changes only)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: model-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Build
        run: make build

      - name: Checkout model catalog
        uses: actions/checkout@v4
        with:
          repository: midfusionlabs/model-catalog
          token: ${{ secrets.GH_PAT }}
          path: model-catalog

      - name: Run sync
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          FIREWORKS_API_KEY: ${{ secrets.FIREWORKS_API_KEY }}
          DEEPINFRA_API_KEY: ${{ secrets.DEEPINFRA_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          MOONSHOT_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
          NEBIUS_API_KEY: ${{ secrets.NEBIUS_API_KEY }}
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
          INCEPTION_API_KEY: ${{ secrets.INCEPTION_API_KEY }}
          LLAMA_API_KEY: ${{ secrets.LLAMA_API_KEY }}
          UPSTAGE_API_KEY: ${{ secrets.UPSTAGE_API_KEY }}
          NOVA_API_KEY: ${{ secrets.NOVA_API_KEY }}
          NOVITA_API_KEY: ${{ secrets.NOVITA_API_KEY }}
          FRIENDLI_TOKEN: ${{ secrets.FRIENDLI_TOKEN }}
          STEPFUN_API_KEY: ${{ secrets.STEPFUN_API_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          VENICE_API_KEY: ${{ secrets.VENICE_API_KEY }}
          BAILING_API_TOKEN: ${{ secrets.BAILING_API_TOKEN }}
          SENTINEL_CATALOG_PATH: ./model-catalog
          SENTINEL_GITHUB_OWNER: midfusionlabs
          SENTINEL_GITHUB_REPO: model-catalog
          SENTINEL_GITHUB_BASE_BRANCH: main
        run: |
          ARGS="sync"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          if [ -n "${{ github.event.inputs.providers }}" ]; then
            ARGS="$ARGS --providers=${{ github.event.inputs.providers }}"
          fi

          ./bin/sentinel $ARGS

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "DISCORD_WEBHOOK not set, skipping notification"
            exit 0
          fi

          if [ "${{ job.status }}" = "success" ]; then
            COLOR=3066993
            TITLE="Sentinel sync completed"
            DESC="Model catalog sync finished successfully."
          elif [ "${{ job.status }}" = "cancelled" ]; then
            COLOR=15105570
            TITLE="Sentinel sync cancelled"
            DESC="Model catalog sync was cancelled."
          else
            COLOR=15158332
            TITLE="Sentinel sync failed"
            DESC="Model catalog sync encountered an error. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          fi

          curl -s -H "Content-Type: application/json" -d "{
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DESC\",
              \"color\": $COLOR,
              \"footer\": {\"text\": \"${{ github.repository }} â€¢ Run #${{ github.run_number }}\"}
            }]
          }" "$DISCORD_WEBHOOK"
